<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EM Data Processing Pipeline Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 20px;
        }
        pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
        }
        code {
            background: #eee;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EM Data Processing Pipeline Documentation</h1>

        <hr>

        <h2>Background Information</h2>
        <p>This pipeline processes electron microscopy (EM) data by following a series of steps that include tiling the data, running inference with the Empanada model, performing SAM inference, extracting points, merging tiles, and finally stitching the results into a single TIFF file. This end-to-end pipeline ensures efficient processing of large EM datasets while maintaining the integrity and quality of the data.</p>
        <p>The pipeline is designed to handle large datasets by breaking them into manageable tiles and chunks, performing processing on each piece, and then reassembling the processed data. The use of GPU resources where available, along with memory management techniques, ensures that the pipeline can handle large volumes of data efficiently.</p>

        <hr>

        <h2>Prerequisites</h2>
        <p>Ensure you have the following prerequisites installed in a clean environment:</p>
        <pre><code>
# Install CUDA 12.1
pip install cuda=12.1

# Install cuDNN
pip install cudnn

# Install PyTorch with CUDA support
conda install pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia

# Install Empanada
conda install empanada-dl

# Install Micro-SAM
mamba install -c pytorch -c conda-forge micro_sam
        </code></pre>

        <hr>

        <h2>Tiler Script Documentation (tiler.py)</h2>
        <p>This script processes a TIFF stack into smaller tiles for further analysis.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>load_tiff_stack(file_path, start_slice, end_slice)</code>: Loads a chunk of a TIFF stack.</li>
            <li><code>tile_chunk(chunk, tile_shape)</code>: Tiles a chunk of the TIFF stack into smaller tiles.</li>
            <li><code>save_tile(tile, index, directory)</code>: Saves a tile to a file.</li>
            <li><code>print_memory_usage(stage)</code>: Prints the current memory usage.</li>
            <li><code>main(tiff_path, output_dir, block_size, chunk_size, tile_shape)</code>: Main function to process the TIFF stack.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python tiler.py &lt;tiff_path&gt; &lt;output_dir&gt; --block_size &lt;block_size&gt; --chunk_size &lt;chunk_size&gt; --tile_shape &lt;height&gt; &lt;width&gt;</code></pre>

        <hr>

        <h2>Empanada Inference Script Documentation (empanada.py)</h2>
        <p>This script runs the Empanada model inference on the tiles generated by the Tiler script.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>run_empanada_inference(tile, config_path, temp_tile_path, tile_idx, args)</code>: Runs Empanada inference on a tile and saves the result.</li>
            <li><code>log_memory_usage(stage)</code>: Logs the current memory usage.</li>
            <li><code>process_tiles(input_dir, config_path, output_dir, args)</code>: Processes all tiles in the input directory and runs Empanada inference on each.</li>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
            <li><code>main()</code>: Main function to run Empanada inference on all tiles.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python empanada.py &lt;input_dir&gt; &lt;output_dir&gt;</code></pre>

        <hr>

        <h2>SAM Inference Script Documentation (samboxes.py)</h2>
        <p>This script runs SAM inference on the tiles using bounding boxes extracted from Empanada results.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>print_memory_usage()</code>: Logs the current memory usage.</li>
            <li><code>load_tile(tile_path)</code>: Loads a tile from a specified path.</li>
            <li><code>extract_bounding_boxes(empanada_results, enlargement_factor)</code>: Extracts bounding boxes from Empanada results.</li>
            <li><code>run_sam_inference(predictor, image, boxes, batch_size)</code>: Runs SAM inference on an image with given bounding boxes.</li>
            <li><code>process_and_save_tile(predictor, raw_tile, boxes, tile_idx, output_dir)</code>: Processes and saves a tile with SAM inference.</li>
            <li><code>load_empanada_results(empanada_dir)</code>: Loads Empanada results from a directory.</li>
            <li><code>main(input_dir, empanada_dir, output_dir, enlargement_factor, tile_shape)</code>: Main function to run SAM inference on all tiles.</li>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python samboxes.py &lt;input_dir&gt; &lt;empanada_dir&gt; &lt;output_dir&gt; --enlargement_factor &lt;factor&gt; --tile_shape &lt;height&gt; &lt;width&gt;</code></pre>

        <hr>

        <h2>SAM Points Extraction Script Documentation (sampoints.py)</h2>
        <p>This script extracts points and centroids from SAM results, filters small masks, and runs SAM inference again.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>print_memory_usage()</code>: Logs the current memory usage.</li>
            <li><code>load_tile(tile_path)</code>: Loads a tile from a specified path.</li>
            <li><code>load_sam_results(sam_dir)</code>: Loads SAM results from a specified directory.</li>
            <li><code>extract_centroids_and_points(sam_results, min_area)</code>: Extracts centroids and points from SAM results for small masks and removes small masks.</li>
            <li><code>run_sam_inference(predictor, image, points, point_labels, batch_size)</code>: Runs SAM inference on an image using specified points and point labels.</li>
            <li><code>process_and_save_tile(predictor, raw_tile, points, point_labels, cleaned_sam_results, tile_idx, output_dir)</code>: Processes and saves a tile after running SAM inference and combining results.</li>
            <li><code>main(sam_dir, raw_dir, output_dir)</code>: Main function to run the SAM inference pipeline.</li>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python sampoints.py &lt;sam_dir&gt; &lt;raw_dir&gt; &lt;output_dir&gt;</code></pre>

        <hr>

        <h2>Tile Merging Script Documentation (mergealltiles.py)</h2>
        <p>This script merges tiles using a multicut segmentation approach.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>print_memory_usage(stage)</code>: Logs the current memory usage.</li>
            <li><code>process_tile(tile_path, output_dir, gap_closing, min_z_extent, beta)</code>: Processes a single tile and merges segmentations.</li>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
            <li><code>main()</code>: Main function to merge tiles using the mergetile.py script.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python mergealltiles.py &lt;tile_path&gt; &lt;output_dir&gt;</code></pre>

        <hr>

        <h2>Tile Stitching Script Documentation (stitch_save.py)</h2>
        <p>This script stitches tiles from a directory into a single array and saves it as a TIFF file.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>print_memory_usage()</code>: Logs the current memory usage.</li>
            <li><code>stitch_tiles_from_directory(input_dir, original_shape, tile_shape)</code>: Stitches tiles from a directory into a single array.</li>
            <li><code>main(input_dir, output_tiff_path, original_shape, tile_shape)</code>: Main function to stitch tiles and save the result as a TIFF file.</li>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python stitch_save.py &lt;input_dir&gt; &lt;output_tiff_path&gt; --original_shape &lt;depth&gt; &lt;height&gt; &lt;width&gt; --tile_shape &lt;depth&gt; &lt;height&gt; &lt;width&gt;</code></pre>

        <hr>

        <h2>End-to-End Pipeline Script Documentation (pipeline.py)</h2>
        <p>This script runs the entire EM data processing pipeline end-to-end.</p>
        <h3>Functions</h3>
        <ul>
            <li><code>parse_args()</code>: Parses command line arguments.</li>
            <li><code>run_tiler(input_tiff, output_dir, block_size, chunk_size, tile_shape)</code>: Runs the Tiler script.</li>
            <li><code>run_empanada(input_dir, output_dir)</code>: Runs the Empanada inference script.</li>
            <li><code>run_sam(input_dir, empanada_dir, output_dir)</code>: Runs the SAM inference script.</li>
            <li><code>run_points(sam_dir, raw_dir, output_dir)</code>: Runs the SAM points extraction script.</li>
            <li><code>run_merge(input_dir, output_dir)</code>: Runs the tile merging script.</li>
            <li><code>run_stitch(input_dir, output_tiff_path, original_shape, tile_shape)</code>: Runs the tile stitching script.</li>
            <li><code>main()</code>: Main function to run the entire EM data processing pipeline.</li>
        </ul>
        <h3>Usage</h3>
        <pre><code>python pipeline.py &lt;input_tiff&gt; &lt;output_dir&gt; --block_size &lt;block_size&gt; --chunk_size &lt;chunk_size&gt; --tile_shape &lt;height&gt; &lt;width&gt; --original_shape &lt;depth&gt; &lt;height&gt; &lt;width&gt;</code></pre>
    </div>
</body>
</html>
